<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ev Barmeni</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* Açık Gri Arka Plan */
            color: #111827; /* Koyu Yazı */
        }
        .font-display {
            font-family: 'Playfair Display', serif;
        }
        .custom-checkbox:checked {
            background-color: #db2777; /* Pembe */
            border-color: #db2777;
        }
        .custom-checkbox:checked + label {
            color: #db2777;
            font-weight: 600;
        }
        .modal.hidden { display: none; }
        .modal { transition: opacity 0.3s ease; }
        #chat-window { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        .chat-bubble-user { background-color: #db2777; color: #fff; }
        .chat-bubble-ai { background-color: #e5e7eb; color: #1f2937; }
        #chat-messages::-webkit-scrollbar { width: 8px; }
        #chat-messages::-webkit-scrollbar-track { background: #f1f5f9; }
        #chat-messages::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 10px; border: 2px solid #f1f5f9; }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">

        <!-- Başlık Bölümü -->
        <header class="text-center mb-12">
            <h1 class="text-4xl sm:text-5xl md:text-6xl font-display text-pink-600">Ev Barmeni</h1>
            <p class="text-lg sm:text-xl text-gray-600 mt-4 max-w-3xl mx-auto">Tarif kitabına göz at, elindeki malzemeleri seç veya bırak barmenlerimiz sana özel tarifler hazırlasın.</p>
        </header>

        <!-- Arama ve Keşfet Bölümü -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-12 border border-gray-200">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Tarifleri Keşfet</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Malzeme Dolabım -->
                <div class="flex flex-col">
                    <h3 class="text-lg font-semibold mb-3 text-pink-600">Malzeme Dolabım</h3>
                    <p class="text-gray-500 mb-4 text-sm">Elindeki malzemeleri seç, sana özel tarifleri bulalım.</p>
                    <div id="ingredients-container" class="max-h-48 overflow-y-auto pr-2 space-y-2">
                        <!-- Malzemeler buraya gelecek -->
                    </div>
                     <button id="find-cocktails-btn" class="mt-auto w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Malzemelerimle Bul
                    </button>
                </div>
                <!-- Tek Alkolle Keşfet -->
                <div class="flex flex-col">
                    <h3 class="text-lg font-semibold mb-3 text-pink-600">Tek Alkolle Keşfet</h3>
                     <p class="text-gray-500 mb-4 text-sm">Bir alkol seç, onunla yapılan tüm tarifleri gör.</p>
                    <select id="single-alcohol-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-pink-500 focus:border-pink-500 block w-full p-2.5">
                        <!-- Alkoller buraya eklenecek -->
                    </select>
                    <button id="find-by-single-alcohol-btn" class="mt-auto w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Bu Alkolle Keşfet
                    </button>
                </div>
            </div>
             <!-- Tüm Tarifler Butonu -->
            <div class="text-center mt-8 border-t border-gray-200 pt-6">
                <button id="show-all-btn" class="w-full sm:w-auto bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                    Tüm Tarif Kitabını Göster
                </button>
            </div>
        </div>
        
        <!-- Sonuç Alanı veya Kategorize Edilmiş Tarif Kitabı -->
        <div id="results-area">
            <!-- Başlangıçta kategorize edilmiş tarifler buraya gelecek -->
        </div>

    </div>

    <!-- Modallar -->
    <div id="ice-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Bir Saniye...</h3>
            <p class="text-gray-600 mb-6">"Buz" seçmediğini fark ettik. Çoğu kokteyl için buz gerekir. Dolabında buz var mı?</p>
            <div class="flex justify-around">
                <button id="ice-confirm-no" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full">Hayır, Buzum Yok</button>
                <button id="ice-confirm-yes" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-6 rounded-full">Evet, Buzum Var!</button>
            </div>
        </div>
    </div>
    <div id="recipe-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto relative"></div>
    </div>
    
    <!-- Yapay Zeka Sohbet Butonları ve Penceresi -->
    <div id="chat-container" class="fixed bottom-5 right-5 z-50 flex flex-col items-end gap-4">
        <!-- Trabzonlu Barmen Butonu -->
        <button data-character="TrabzonluBarmen" class="chat-fab-btn flex items-center gap-2 bg-blue-600 text-white font-bold px-4 py-3 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transform hover:scale-110 transition-transform duration-300">
             <span class="sm:inline">Trabzonlu Barmen'e Sor</span>
        </button>
        <!-- Tipsy Witch Butonu -->
        <button data-character="tipsyWitch" class="chat-fab-btn flex items-center gap-2 bg-purple-600 text-white font-bold px-4 py-3 rounded-full shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-400 transform hover:scale-110 transition-transform duration-300">
             <span class="sm:inline">Tipsy Witch'e Sor</span>
        </button>
        <!-- Sohbet Penceresi -->
        <div id="chat-window" class="hidden absolute bottom-20 right-0 w-80 sm:w-96 bg-white rounded-2xl shadow-2xl border border-gray-200 flex flex-col transform translate-y-4 opacity-0">
            <div id="chat-header" class="flex items-center justify-between p-3 border-b border-gray-200">
                <div class="flex items-center">
                    <img id="chat-avatar" src="" alt="Avatar" class="w-10 h-10 rounded-full mr-3 border-2">
                    <div>
                        <p id="chat-name" class="font-bold text-gray-800"></p>
                        <p class="text-xs text-green-500">Çevrimiçi</p>
                    </div>
                </div>
                <button id="close-chat" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-scroll h-96 bg-gray-50"></div>
            <div class="p-3 border-t border-gray-200 flex items-center">
                <input type="text" id="chat-input" placeholder="Bir şeyler sor..." class="flex-1 bg-gray-100 text-gray-800 rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-pink-500">
                <button id="send-chat" class="ml-3 bg-pink-600 text-white rounded-full p-2 hover:bg-pink-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            let ingredientsDB = {};
            let cocktailsDB = [];

            try {
                const response = await fetch('./database.json');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                ingredientsDB = data.ingredientsDB;
                cocktailsDB = data.cocktailsDB;
            } catch (error) {
                console.error("Veritabanı yüklenemedi:", error);
                document.getElementById('results-area').innerHTML = '<p class="text-center text-red-500">Tarifler yüklenemedi. Lütfen database.json dosyasının doğru yerde olduğundan emin olun.</p>';
                return;
            }

            const ingredientsContainerEl = document.getElementById('ingredients-container');
            const findCocktailsBtn = document.getElementById('find-cocktails-btn');
            const showAllBtn = document.getElementById('show-all-btn');
            const singleAlcoholSelect = document.getElementById('single-alcohol-select');
            const findBySingleAlcoholBtn = document.getElementById('find-by-single-alcohol-btn');
            const resultsArea = document.getElementById('results-area');
            const recipeModalEl = document.getElementById('recipe-modal');
            const modalContentEl = document.getElementById('modal-content');
            const iceModalEl = document.getElementById('ice-modal');
            const iceConfirmYesBtn = document.getElementById('ice-confirm-yes');
            const iceConfirmNoBtn = document.getElementById('ice-confirm-no');
            const chatWindow = document.getElementById('chat-window');
            const closeChat = document.getElementById('close-chat');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendChat = document.getElementById('send-chat');

            const aiCharacters = {
                tipsyWitch: {
                    name: "Tipsy Witch",
                    avatar: "./tipsy-witch-avatar.png",
                    borderColor: "border-purple-500",
                    welcomeMessage: "Selam tatlım... Elinde sihirli bir iksir var da, onunla ne yapacağını mı bilmiyorsun? Söyle bana ana malzemen ne, sana birkaç büyü fısıldayayım.",
                    systemPrompt: `Sen 'Tipsy Witch' adında kadın bir barmaidsin. Karakterin dobra, flörtöz, alaycı ama işinin ehli. Sana sorulan kokteyl ve içki sorularına bu karakterle cevap ver. Sadece sana verilen tarif listesini kullan. Eğer listede olmayan bir şey sorulursa, "Elimde öyle bir büyü yok tatlım, ama istersen sana başka iksirler önerebilirim" de. Eğer kullanıcı listede olmayan malzemeleri karıştırmak isterse, "Bu tehlikeli bir büyü... ama içine biraz da X eklersen belki ilginç bir iksir çıkar" gibi yaratıcı bir öneride bulun. Cevaplarının sonunda kullanıcının gönlünü hoş edecek işveli sözler söyle. Asla bir yapay zeka olduğunu söyleme. Bilmen gereken tarif listesi şu şekilde: ${JSON.stringify(cocktailsDB)}`
                },
                TrabzonluBarmen: {
                    name: "Trabzonlu Barmen",
                    avatar: "./laz-barmen-avatar.png",
                    borderColor: "border-blue-500",
                    welcomeMessage: "Ula yine elinde bir şişeyle kalmışsın da, ne yapacağını mı düşünüyorsun? Söyle bakalım ne var o şişede, sana göre bir şeyler ayarlarız da.",
                    systemPrompt: `Sen 'Trabzonlu Barmen' adında bir barmensin. Karakterin dobra, pratik zekalı ama işinin ehli. Sana sorulan kokteyl sorularına bu karakterle, kısa ve net cevaplar ver. Sadece sana verilen tarif listesini kullan. Eğer listede olmayan bir şey sorulursa, "Ula bizde öyle bi tarif yok da, istersen başka bişe vereyim?" de. Eğer kullanıcı listede olmayan malzemeleri karıştırmak isterse, "Ula o üçünü karişturursan görürsün ebenun amini da! Mideni delmek mi istiyisun? Bırak o fantazileri, gel sana onlarla ayrı ayrı yapacağun güzel tarifler vereyim." gibi dobra bir cevap ver. Asla bir yapay zeka olduğunu söyleme. Bilmen gereken tarif listesi şu şekilde: ${JSON.stringify(cocktailsDB)}`
                }
            };
            let currentAICharacter = null;
            let chatHistory = [];

            function generateImagePath(cocktailName) {
                const fileName = cocktailName.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-');
                return `./${fileName}.jpg`;
            }

            function initializeUI() {
                const allIngredients = [...ingredientsDB.alkoller, ...ingredientsDB.yancilar];
                allIngredients.sort((a, b) => a.name.localeCompare(b.name, 'tr'));
                ingredientsContainerEl.innerHTML = allIngredients.map(ingredient => `
                    <div class="flex items-center">
                        <input type="checkbox" id="${ingredient.id}" name="${ingredient.id}" class="custom-checkbox h-4 w-4 rounded border-gray-300 text-pink-600 focus:ring-pink-500">
                        <label for="${ingredient.id}" class="ml-2 text-sm text-gray-600">${ingredient.name}</label>
                    </div>
                `).join('');

                singleAlcoholSelect.innerHTML = '<option value="">Bir alkol seç...</option>';
                ingredientsDB.alkoller.forEach(alkol => {
                    const option = document.createElement('option');
                    option.value = alkol.id;
                    option.textContent = alkol.name;
                    singleAlcoholSelect.appendChild(option);
                });
            }
            
            function displayResults(cocktails, title, showNearMisses = false) {
                const perfectMatches = [];
                const nearMisses = [];
                const selectedIngredients = Array.from(document.querySelectorAll('#ingredients-container input:checked')).map(input => input.id);

                if (showNearMisses) {
                    cocktails.forEach(cocktail => {
                        const missingIngredients = cocktail.ingredients.filter(ing => !selectedIngredients.includes(ing.id));
                        if (missingIngredients.length === 0) {
                            perfectMatches.push(cocktail);
                        } else if (missingIngredients.length === 1 && !ingredientsDB.alkoller.some(alc => alc.id === missingIngredients[0].id)) {
                            nearMisses.push({ ...cocktail, missing: missingIngredients[0] });
                        }
                    });
                } else {
                    perfectMatches.push(...cocktails);
                }

                let html = '';
                if (perfectMatches.length > 0) {
                    html += `<h2 class="text-2xl font-bold mb-6 text-gray-800">${title}</h2>`;
                    html += '<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">';
                    perfectMatches.forEach(cocktail => {
                        const imagePath = generateImagePath(cocktail.name);
                        html += `
                            <div class="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer transform hover:-translate-y-1 transition-transform" onclick='showRecipeModal(${JSON.stringify(cocktail)})'>
                                <img src="${imagePath}" alt="${cocktail.name}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x400/e5e7eb/9ca3af?text=Resim+Yok';">
                                <div class="p-4">
                                    <h3 class="text-lg font-semibold text-gray-800">${cocktail.name}</h3>
                                </div>
                            </div>`;
                    });
                    html += '</div>';
                }

                if (nearMisses.length > 0) {
                    html += `<h2 class="text-2xl font-bold mt-12 mb-6 text-orange-500">Sadece 1 Malzeme Eksik!</h2>`;
                    html += '<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">';
                    nearMisses.forEach(cocktail => {
                        const imagePath = generateImagePath(cocktail.name);
                        const missingIngredientInfo = [...ingredientsDB.alkoller, ...ingredientsDB.yancilar].find(i => i.id === cocktail.missing.id);
                        html += `
                            <div class="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer transform hover:-translate-y-1 transition-transform border-2 border-dashed border-orange-400" onclick='showRecipeModal(${JSON.stringify(cocktail)})'>
                                <img src="${imagePath}" alt="${cocktail.name}" class="w-full h-48 object-cover opacity-70" onerror="this.onerror=null;this.src='https://placehold.co/400x400/e5e7eb/9ca3af?text=Resim+Yok';">
                                <div class="p-4">
                                    <h3 class="text-lg font-semibold text-orange-500">${cocktail.name}</h3>
                                    <div class="mt-2 bg-orange-100 text-orange-700 p-2 rounded-lg text-center text-sm">
                                        <p class="font-bold">Sadece bu eksik: ${missingIngredientInfo.name}</p>
                                    </div>
                                </div>
                            </div>`;
                    });
                    html += '</div>';
                }

                if (perfectMatches.length === 0 && nearMisses.length === 0) {
                    html = `<p class="text-center text-gray-500 mt-8">Uygun bir kokteyl bulunamadı.</p>`;
                }
                
                resultsArea.innerHTML = html;
            }

            function renderCategorizedCookbook() {
                const categorized = {};
                cocktailsDB.forEach(cocktail => {
                    const base = ingredientsDB.alkoller.find(a => a.id === cocktail.base_alcohol);
                    if (base) {
                        if (!categorized[base.name]) {
                            categorized[base.name] = [];
                        }
                        categorized[base.name].push(cocktail);
                    }
                });

                let html = '';
                for (const category in categorized) {
                    html += `<h2 class="text-3xl font-bold mb-6 text-gray-800 border-b-2 border-pink-500 pb-2">${category} Kokteylleri</h2>`;
                    html += '<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-12">';
                    categorized[category].forEach(cocktail => {
                        const imagePath = generateImagePath(cocktail.name);
                        html += `
                            <div class="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer transform hover:-translate-y-1 transition-transform" onclick='showRecipeModal(${JSON.stringify(cocktail)})'>
                                <img src="${imagePath}" alt="${cocktail.name}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x400/e5e7eb/9ca3af?text=Resim+Yok';">
                                <div class="p-4">
                                    <h3 class="text-lg font-semibold text-gray-800">${cocktail.name}</h3>
                                </div>
                            </div>`;
                    });
                    html += '</div>';
                }
                resultsArea.innerHTML = html;
            }
            
            window.showRecipeModal = function(cocktail) {
                let totalPureAlcohol = 0;
                cocktail.ingredients.forEach(ing => {
                    const alcoholInfo = ingredientsDB.alkoller.find(alc => alc.id === ing.id);
                    if (alcoholInfo) {
                        const amount = parseFloat(ing.amount);
                        if (!isNaN(amount)) {
                            totalPureAlcohol += amount * (alcoholInfo.abv / 100);
                        }
                    }
                });
                const imagePath = generateImagePath(cocktail.name);

                modalContentEl.innerHTML = `
                    <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-2xl z-10">&times;</button>
                    <img src="${imagePath}" alt="${cocktail.name}" class="w-full h-64 object-cover rounded-t-2xl" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e5e7eb/9ca3af?text=Resim+Yok';">
                    <div class="p-6">
                        <h2 class="text-3xl font-display text-pink-600 mb-4">${cocktail.name}</h2>
                        <div class="flex justify-around text-center mb-6 bg-gray-100 p-3 rounded-lg">
                            <div><p class="text-sm text-gray-500">Kalori</p><p class="text-lg font-bold text-gray-800">${cocktail.calories} kcal</p></div>
                            <div><p class="text-sm text-gray-500">Saf Alkol</p><p class="text-lg font-bold text-gray-800">${totalPureAlcohol.toFixed(1)} cl</p></div>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Malzemeler</h3>
                        <ul class="list-disc list-inside mb-6 text-gray-600">
                            ${cocktail.ingredients.map(ing => { const ingInfo = [...ingredientsDB.alkoller, ...ingredientsDB.yancilar].find(i => i.id === ing.id); return `<li>${ing.amount} ${ingInfo.name}</li>`; }).join('')}
                        </ul>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Yapılışı</h3>
                        <p class="text-gray-600 leading-relaxed">${cocktail.instructions}</p>
                    </div>`;
                recipeModalEl.classList.remove('hidden');
                document.getElementById('close-modal-btn').addEventListener('click', () => recipeModalEl.classList.add('hidden'));
            }
            
            function startSearchProcess() {
                const selectedAnyIngredient = document.querySelector('#ingredients-container input:checked');
                if (!selectedAnyIngredient) {
                    alert('Lütfen en az bir malzeme seçin!');
                    return;
                }
                const isBuzSelected = document.getElementById('buz').checked;
                if (!isBuzSelected) {
                    iceModalEl.classList.remove('hidden');
                } else {
                    const selectedIngredients = Array.from(document.querySelectorAll('#ingredients-container input:checked')).map(input => input.id);
                    const availableCocktails = cocktailsDB.filter(cocktail => cocktail.ingredients.every(ing => selectedIngredients.includes(ing.id)));
                    displayResults(cocktailsDB, 'Yapabileceğin Kokteyller', true);
                }
            }

            function handleSingleAlcoholSearch() {
                const selectedAlcoholId = singleAlcoholSelect.value;
                if (!selectedAlcoholId) {
                    alert('Lütfen bir alkol seçin.');
                    return;
                }
                const selectedAlcohol = ingredientsDB.alkoller.find(a => a.id === selectedAlcoholId);
                const matchingCocktails = cocktailsDB.filter(cocktail => cocktail.ingredients.some(ing => ing.id === selectedAlcoholId));
                displayResults(matchingCocktails, `${selectedAlcohol.name} ile Yapabileceğin Kokteyller`);
            }

            function setupChatWindow(characterKey) {
                currentAICharacter = aiCharacters[characterKey];
                chatHistory = [];
                document.getElementById('chat-avatar').src = currentAICharacter.avatar;
                document.getElementById('chat-name').textContent = currentAICharacter.name;
                const avatarImg = document.getElementById('chat-avatar');
                avatarImg.classList.remove('border-purple-500', 'border-blue-500');
                avatarImg.classList.add(currentAICharacter.borderColor);
                chatMessages.innerHTML = '';
                appendMessage(currentAICharacter.welcomeMessage, 'ai');
            }

            async function askBarmaidAI() {
                const userMessage = chatInput.value.trim();
                if (!userMessage || !currentAICharacter) return;
                appendMessage(userMessage, 'user');
                chatInput.value = '';
                appendMessage('...', 'ai', true);
                chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
                try {
                    const apiKey = "AIzaSyBEphcJz_gqnj671A7adQKBUlcmo9TsnsQ"; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    if (apiKey.startsWith("BURAYA")) {
                        updateLastMessage("API anahtarı eksik.");
                        return;
                    }
                    const payload = { contents: [ { role: "user", parts: [{ text: currentAICharacter.systemPrompt }] }, ...chatHistory ] };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API hatası: ${response.status}`);
                    const result = await response.json();
                    const aiMessage = result.candidates[0].content.parts[0].text;
                    chatHistory.push({ role: "model", parts: [{ text: aiMessage }] });
                    updateLastMessage(aiMessage);
                } catch (error) {
                    console.error("Yapay Zeka Hatası:", error);
                    updateLastMessage("Kusura bakma, şu an kafam kazan gibi. Sonra konuşalım.");
                }
            }

            function appendMessage(text, sender, isTyping = false) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start');
                const bubble = document.createElement('div');
                bubble.classList.add(sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai', 'p-3', 'rounded-lg', 'max-w-xs', 'text-sm', 'sm:text-base');
                if (isTyping) {
                    bubble.id = 'typing-indicator';
                    bubble.innerHTML = `<p class="animate-pulse">${text}</p>`;
                } else {
                    bubble.innerHTML = `<p>${text}</p>`;
                }
                messageDiv.appendChild(bubble);
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function updateLastMessage(text) {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.innerHTML = `<p>${text}</p>`;
                    typingIndicator.removeAttribute('id');
                    typingIndicator.querySelector('p').classList.remove('animate-pulse');
                }
            }

            // Olay dinleyicileri
            findCocktailsBtn.addEventListener('click', startSearchProcess);
            showAllBtn.addEventListener('click', renderCategorizedCookbook);
            findBySingleAlcoholBtn.addEventListener('click', handleSingleAlcoholSearch);
            iceConfirmYesBtn.addEventListener('click', () => {
                document.getElementById('buz').checked = true;
                iceModalEl.classList.add('hidden');
                startSearchProcess();
            });
            iceConfirmNoBtn.addEventListener('click', () => {
                iceModalEl.classList.add('hidden');
                startSearchProcess();
            });
            recipeModalEl.addEventListener('click', (e) => {
                if (e.target.id === 'recipe-modal') {
                    recipeModalEl.classList.add('hidden');
                }
            });
            document.querySelectorAll('.chat-fab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const characterKey = e.currentTarget.dataset.character;
                    setupChatWindow(characterKey);
                    chatWindow.classList.remove('hidden');
                    setTimeout(() => {
                        chatWindow.classList.remove('opacity-0', 'translate-y-4');
                    }, 10);
                });
            });
            closeChat.addEventListener('click', () => {
                chatWindow.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => {
                    chatWindow.classList.add('hidden');
                }, 300);
            });
            sendChat.addEventListener('click', askBarmaidAI);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') askBarmaidAI();
            });

            // Başlangıç
            initializeUI();
            renderCategorizedCookbook(); // Sayfa ilk açıldığında tarif kitabını göster
        });
    </script>
</body>
</html>
